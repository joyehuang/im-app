// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  nickname  String
  avatar    String?
  status    String   @default("offline")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sentMessages      Message[]           @relation("SentMessages")
  messageReads      MessageRead[]
  friendshipsInitiated Friendship[]      @relation("UserFriendships")
  friendshipsReceived Friendship[]      @relation("FriendFriendships")
  conversationsCreated Conversation[]    @relation("CreatedConversations")
  conversationMembers ConversationMember[]

  @@map("users")
}

model Friendship {
  id        String   @id @default(uuid())
  userId    String
  friendId  String
  status    String   @default("accepted")
  createdAt DateTime @default(now())

  user   User @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("FriendFriendships", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friendships")
}

model Conversation {
  id        String   @id @default(uuid())
  type      String
  name      String?
  avatar    String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User               @relation("CreatedConversations", fields: [createdBy], references: [id])
  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

model ConversationMember {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  role           String   @default("member")
  joinedAt       DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_members")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  type           String
  content        String?
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  isRead         Boolean  @default(false)
  isEdited       Boolean  @default(false)
  editedAt       DateTime?
  isRevoked      Boolean  @default(false)
  revokedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User              @relation("SentMessages", fields: [senderId], references: [id])
  reads        MessageRead[]

  @@map("messages")
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_reads")
}
